--This is a test of the "edge id X not found in cache" error when using sdo_topo_map.move_node
--Submitted by: Matt Schell, CPB, Census
--Contact: Matt Schell (matthew.c.schell@census.gov)

--For some moves sdo_topo_map.move_node will only succeed when the entire topology is in cache
--The error is thrown when move_node is called with the signature that includes the topology name 
--The error is also thrown with a NULL topology and a topomap that includes a reasonable window
--The edge id identified in the error is not near the node or edges being moved by the move_node call


--first, import the dump file MOVEND.dmp
--Source relation$ partition tablespace is GENTOPO_DATA
--imp '<USER>/<PASSWORD>@<DATABASE> FILE=<PATH>/MOVEND.dmp indexes=N grants=N ignore=Y tables=(MOVEND_CLIP_FACE,MOVEND_EDGE$,MOVEND_EXP$,MOVEND_FACE$,MOVEND_HISTORY$,MOVEND_NODE$,MOVEND_RELATION$,MOVEND_STATE_EDGES_Z8_V2)'

--Initialize
--UPDATE MOVEND_exp$ set owner = '<schema>', table_schema = '<schema>'; 
--commit;
--BEGIN
--SDO_TOPO.INITIALIZE_AFTER_IMPORT('MOVEND');
--END;


--then run the following block
DECLARE

retval         VARCHAR2(4000);
myedgearr      SDO_EDGE_ARRAY   := SDO_EDGE_ARRAY();
numarray1      SDO_NUMBER_ARRAY := SDO_NUMBER_ARRAY();
numarray2      SDO_NUMBER_ARRAY := SDO_NUMBER_ARRAY();
numarray3      SDO_NUMBER_ARRAY := SDO_NUMBER_ARRAY();

BEGIN

--no error means validation success
retval := SDO_TOPO_MAP.VALIDATE_TOPOLOGY('MOVEND');


numarray1.EXTEND(76);
numarray2.EXTEND(54);
numarray3.EXTEND(98);

--set edges in correct order according to node star
--moving node 206 due west

numarray1 := SDO_NUMBER_ARRAY(-98.49954994747019532042031642049551010132,
   42.99855977809750129381427541375160217285,
   -98.56507200000000068484951043501496315002,
   42.99839999999999662350091966800391674042,
   -98.56893599999999366900738095864653587341,
   42.99853699999999889769242145121097564697,
   -98.66371200000000385443854611366987228394,
   42.99844399999999922101778793148696422577,
   -98.66561299999999334886524593457579612732,
   42.99853600000000142244971357285976409912,
   -98.74239400000000443924363935366272926331,
   42.99834299999999842611941858194768428802,
   -98.76437799999999356259650085121393203735,
   42.99832299999999918327375780791044235229,
   -98.80130400000000179261405719444155693054,
   42.99824100000000015597834135405719280243,
   -98.8239889999999974179445416666567325592,
   42.99830999999999647798176738433539867401,
   -98.89994400000000496220309287309646606445,
   42.9981220000000021741470845881849527359,
   -98.90315400000000067848304752260446548462,
   42.99830599999999947158357826992869377136,
   -98.9191359999999946239768178202211856842,
   42.99824199999999763122104923240840435028,
   -98.91923400000000299314706353470683097839,
   42.99824100000000015597834135405719280243,
   -98.96208099999999774354364490136504173279,
   42.99828600000000022873791749589145183563,
   -99.00037000000000375621311832219362258911,
   42.99827299999999752344592707231640815735,
   -99.02190899999999373903847299516201019287,
   42.9983649999999997248778527136892080307,
   -99.02230000000000131876731757074594497681,
   42.99823700000000314958015223965048789978,
   -99.08001099999999894407665124163031578064,
   42.99835699999999860665411688387393951416,
   -99.08187999999999817646312294527888298035,
   42.99828800000000228465069085359573364258,
   -99.13596099999999466945155290886759757996,
   42.99830099999999788451532367616891860962,
   -99.13904499999999586634658044204115867615,
   42.99850800000000106138031696900725364685,
   -99.15114300000000469026417704299092292786,
   42.99834400000000300678948406130075454712,
   -99.16138800000000230738805839791893959045,
   42.99846500000000304453351418487727642059,
   -99.19519900000000234285835176706314086914,
   42.99810699999999741294232080690562725067,
   -99.23446199999999350893631344661116600037,
   42.99828099999999864166966290213167667389,
   -99.25429699999999400006345240399241447449,
   42.99813799999999730516719864681363105774,
   -99.26270999999999844476405996829271316528,
   42.99823399999999651299731340259313583374,
   -99.28804499999999677584128221496939659119,
   42.99815199999999748570189694873988628387,
   -99.34728300000000444924808107316493988037,
   42.99821699999999680130713386461138725281,
   -99.36862800000000106592779047787189483643,
   42.99813999999999936107997200451791286469,
   -99.37112100000000225463736569508910179138,
   42.99809299999999723240762250497937202454,
   -99.37426800000000071122485678642988204956,
   42.99804699999999968440533848479390144348,
   -99.39556799999999725514499004930257797241,
   42.9981700000000017780621419660747051239,
   -99.47135299999999347164703067392110824585,
   42.99796700000000271302269538864493370056,
   -99.47453099999999892588675720617175102234,
   42.99808099999999910778569756075739860535,
   -99.49079799999999806914274813607335090637,
   42.99814299999999889223545324057340621948,
   -99.49428699999999992087396094575524330139,
   42.99811799999999806232153787277638912201,
   -99.53404927722142758739209966734051704407,
   42.99804058123594074913853546604514122009);

numarray2 := SDO_NUMBER_ARRAY(-99.29799800000000686850398778915405273438,
   43.4996689999999972542354953475296497345,
   -99.31007300000000270756572717800736427307,
   43.4679349999999971032593748532235622406,
   -99.28079800000000432191882282495498657227,
   43.44479700000000121917764772661030292511,
   -99.25591099999999755709723103791475296021,
   43.43708999999999775809556012973189353943,
   -99.16720399999999813189788255840539932251,
   43.43520999999999787632987136021256446838,
   -99.15288900000000182899384526535868644714,
   43.42690799999999740066414233297109603882,
   -99.12638300000000413092493545264005661011,
   43.38062200000000245836417889222502708435,
   -99.10890200000000049840309657156467437744,
   43.37300299999999708688847022131085395813,
   -99.0692849999999936017047730274498462677,
   43.32068799999999697547536925412714481354,
   -99.02024900000000684485712554305791854858,
   43.29061399999999792953531141392886638641,
   -98.98125299999999526789906667545437812805,
   43.25894499999999709416442783549427986145,
   -98.94573499999999910414771875366568565369,
   43.24830599999999947158357826992869377136,
   -98.8967829999999992196535458788275718689,
   43.24690900000000226555130211636424064636,
   -98.88407599999999320061760954558849334717,
   43.23994299999999668671080144122242927551,
   -98.86562700000000347699824487790465354919,
   43.15955399999999997362465364858508110046,
   -98.85359099999999443753040395677089691162,
   43.15462300000000084310158854350447654724,
   -98.7904290000000031568561098538339138031,
   43.15010600000000096088115242309868335724,
   -98.77340599999999426472641061991453170776,
   43.14591899999999924375515547581017017365,
   -98.75036199999999553256202489137649536133,
   43.12953399999999959391061565838754177094,
   -98.71457300000000145701051224023103713989,
   43.08891400000000260206434177234768867493,
   -98.69046000000000162799551617354154586792,
   43.07655599999999651572579750791192054749,
   -98.6450940000000002783053787425160408020,
   43.07128999999999763304003863595426082611,
   -98.61855900000000474392436444759368896484,
   43.07416899999999770898284623399376869202,
   -98.55747700000000577347236685454845428467,
   43.05896500000000060026650317013263702393,
   -98.52487100000000452837412012740969657898,
   43.03934699999999935471350909210741519928,
   -98.50673799999999857845978112891316413879,
   43.01929100000000261161403614096343517303,
   -98.49954994747019532042031642049551010132,
   42.99855977809750129381427541375160217285);
   
numarray3 := SDO_NUMBER_ARRAY(-98.15307905341646232955099549144506454468,
   42.83906544814463757120392983779311180115,
   -98.1632620000000031268427846953272819519,
   42.83714299999999752799340058118104934692,
   -98.16752300000000275304046226665377616882,
   42.8369250000000008071765478234738111496,
   -98.17111300000000539967004442587494850159,
   42.8371139999999996916812960989773273468,
   -98.1897649999999941883288556709885597229,
   42.84162800000000004274625098332762718201,
   -98.20450599999999496958480449393391609192,
   42.84684500000000184627424459904432296753,
   -98.21982599999999763440428068861365318298,
   42.85315700000000305180947179906070232391,
   -98.22423100000000317777448799461126327515,
   42.85552100000000308455128106288611888885,
   -98.22651199999999960255081532523036003113,
   42.85774200000000178079062607139348983765,
   -98.2319219999999972969817463308572769165,
   42.86113999999999890633262111805379390717,
   -98.24683000000000276941136689856648445129,
   42.86839700000000163981894729658961296082,
   -98.24981999999999970896169543266296386719,
   42.87184299999999836927599972113966941833,
   -98.25181000000000608451955486088991165161,
   42.87282400000000137652023113332688808441,
   -98.258275999999995065081748180091381073,
   42.87438999999999822421159478835761547089,
   -98.26836299999999368992575909942388534546,
   42.87415200000000226054908125661313533783,
   -98.28000699999999767442204756662249565125,
   42.87499600000000299360181088559329509735,
   -98.29746500000000253294274443760514259338,
   42.88005900000000281124812318012118339539,
   -98.31951300000000060208549257367849349976,
   42.88454000000000121417542686685919761658,
   -98.32586399999999571264197584241628646851,
   42.88649999999999806732375873252749443054,
   -98.3296629999999964866219670511782169342,
   42.88844100000000025829649530351161956787,
   -98.33242300000000568616087548434734344482,
   42.89050100000000043110048864036798477173,
   -98.33349699999999415922502521425485610962,
   42.89153199999999799274519318714737892151,
   -98.33584600000000364161678589880466461182,
   42.89565400000000039426595321856439113617,
   -98.33799000000000489762896904721856117249,
   42.89775999999999811507223057560622692108,
   -98.34240800000000604086380917578935623169,
   42.90084699999999884312273934483528137207,
   -98.34623000000000558884494239464402198792,
   42.90274699999999796773408888839185237885,
   -98.35804699999999911597114987671375274658,
   42.90751600000000109957909444347023963928,
   -98.37535800000000563159119337797164916992,
   42.9131319999999973902049532625824213028,
   -98.38644499999999482042767340317368507385,
   42.9184070000000019717845134437084197998,
   -98.39929800000000170712155522778630256653,
   42.92246500000000253294274443760514259338,
   -98.40782400000000507134245708584785461426,
   42.92575000000000073896444519050419330597,
   -98.42073999999999500687408726662397384644,
   42.93192400000000219506546272896230220795,
   -98.42628700000000208092387765645980834961,
   42.93209999999999837427822058089077472687,
   -98.43093399999999348892743000760674476624,
   42.93150399999999677902451367117464542389,
   -98.43450300000000652289600111544132232666,
   42.92922699999999736064637545496225357056,
   -98.43728500000000281033862847834825515747,
   42.92839299999999980173015501350164413452,
   -98.43974300000000710042513674125075340271,
   42.92819500000000232375896302983164787292,
   -98.44414500000000600721250521019101142883,
   42.92924200000000212185113923624157905579,
   -98.44586099999999362353264587000012397766,
   42.93061999999999756028046249412000179291,
   -98.44704699999999775172909721732139587402,
   42.93511699999999819965523784048855304718,
   -98.44830899999999473948264494538307189941,
   42.93642799999999937199390842579305171967,
   -98.45221999999999695774022256955504417419,
   42.93838900000000080581230577081441879272,
   -98.45851500000000555701262783259153366089,
   42.94337399999999860256139072589576244354,
   -98.46167300000000466297933598980307579041,
   42.944426999999997462964529404416680336,
   -98.46735599999999521969584748148918151855,
   42.94755599999999873261913307942450046539,
   -98.47891900000000475756678497418761253357,
   42.96353899999999725878296885639429092407,
   -98.49048299999999755982571514323353767395,
   42.97794799999999781903170514851808547974,
   -98.49574699999999438659870065748691558838,
   42.9880319999999969127202348317950963974,
   -98.49954994747019532042031642049551010132,
   42.99855977809750129381427541375160217285);

myedgearr.EXTEND(3);
myedgearr(1) := numarray1;
myedgearr(2) := numarray2;
myedgearr(3) := numarray3;


--Does not work 
--also does not work with a reasonable topomap that covers the extent of the edges and nodes being moved
SDO_TOPO_MAP.MOVE_NODE('MOVEND',206,myedgearr);
--ORA-29532: Java call terminated by uncaught Java exception: 
--oracle.spatial.topo.TopoEntityNotFoundException: Edge ID 337 not found in cache


--only by loading the entire topology into cache will this succeed
--uncomment these lines for comparison
--SDO_TOPO_MAP.CREATE_TOPO_MAP('MOVEND','MOVENDMAP');
--SDO_TOPO_MAP.LOAD_TOPO_MAP('MOVENDMAP', 'TRUE','TRUE');
--SDO_TOPO_MAP.MOVE_NODE(NULL,206,myedgearr);


END;